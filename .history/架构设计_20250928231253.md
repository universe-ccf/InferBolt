# Voicery · 架构设计文档

> 目标：一个可搜索与对话的“角色扮演 + 语音”应用。支持文本与语音双链路、多轮记忆、技能路由（思辨类 & 关怀类 & 教学类），并与七牛云端大模型兼容接口对接（LLM / ASR / TTS）。

---

## 1. 总体架构

┌───────────────┐
│   UI (Gradio) │  main.py + assets/ui.css
└───────┬───────┘
        │ 事件/回调
        ▼
┌──────────────────────────────┐
│         Core Pipeline        │  core/pipeline.py
│ build_system/assemble/run_*  │
│ respond(text)/respond_voice  │
└───────┬───────────┬──────────┘
        │           │
        │           ├─────────────► Skills（策略层）
        │           │               skills/*.py
        │           │   steelman / x_exam / counterfactual
        │           │   luma_* (story / reframe / roleplay)
        │           │   aris_* (reverse / practice / bimap)
        │           │
        │           └─────────────► Dispatcher（意图/技能路由）
        │                           core/dispatcher.py
        │                           规则匹配 + LLM 分类
        │
        ├─────────────────────────► Clients（外部服务）
        │                           clients/llm_client.py  (ChatCompletions + SSE)
        │                           clients/asr_ws_client.py (WS流式ASR)
        │                           clients/tts_client.py  (TTS; 缓存/裁剪)
        │
        └─────────────────────────► State（会话/记忆）
                                    core/state.py + core/types.py


┌───────────────┐
│ UI (Gradio) │ main.py + assets/ui.css
└───────┬───────┘
│ 事件/回调
▼
┌──────────────────────────────┐
│ Core Pipeline │ core/pipeline.py
│ build_system/assemble/run_* │
│ respond(text)/respond_voice │
└───────┬───────────┬──────────┘
│ │
│ ├─────────────► Skills（策略层）
│ │ skills/.py
│ │ steelman / x_exam / counterfactual
│ │ luma_ (story / reframe / roleplay)
│ │ aris_* (reverse / practice / bimap)
│ │
│ └─────────────► Dispatcher（意图/技能路由）
│ core/dispatcher.py
│ 规则匹配 + LLM 分类
│
├─────────────────────────► Clients（外部服务）
│ clients/llm_client.py (ChatCompletions + SSE)
│ clients/asr_ws_client.py (WS流式ASR)
│ clients/tts_client.py (TTS; 缓存/裁剪)
│
└─────────────────────────► State（会话/记忆）
core/state.py + core/types.py